<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor JS con Entrada Paso a Paso</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        textarea {
            width: 90%;
            height: 200px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 14px;
        }

        .instructions {
            width: 90%;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #d4edda; /* Un borde suave y color de fondo */
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.95em;
            color: #333;
        }

        .instructions p {
            margin-bottom: 10px;
        }

        .instructions code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }


        .input-area {
            width: 90%;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            background-color: #f9f9f9;
            display: none; /* Inicialmente oculto */
            flex-direction: column;
        }
        .input-area label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-area input {
            padding: 8px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        .input-area button {
            padding: 8px 15px;
            background-color: #28a745; /* Color verde */
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            align-self: flex-end; /* Alinea el botón a la derecha */
        }
        .input-area button:hover {
            background-color: #218838;
        }

        .button-container {
            width: 90%;
            margin-bottom: 10px;
            display: flex;
            justify-content: center; /* Centra los botones */
            gap: 10px; /* Espacio entre botones */
        }

        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
         button.reset-button {
            background-color: #dc3545; /* Color rojo */
        }
         button.reset-button:hover {
            background-color: #c82333;
        }

        .resultado {
            margin-top: 10px;
            width: 90%;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            min-height: 50px;
        }
        iframe {
            display: none;
            width: 0;
            height: 0;
            border: none;
        }
    </style>
</head>
<body>

    <h1>Editor JS con Entrada Paso a Paso</h1>

    <div class="instructions">
        <p>Para solicitar una entrada al usuario dentro de tu código JavaScript, utiliza la función <code>await solicitarEntrada("Tu mensaje aquí:");</code>.</p>
        <p>La ejecución de tu código se pausará hasta que ingreses un valor en el campo de "Introduce un valor:" que aparecerá y presiones "Enviar" o Enter.</p>
        <p>El valor ingresado estará disponible en la variable que le asignes (como en <code>let miVariable = await solicitarEntrada("...");</code>). Recuerda que el valor siempre se recibe como texto; usa <code>parseFloat()</code> o <code>parseInt()</code> si esperas números.</p>
    </div>

    <textarea id="javascriptCode" placeholder="Escribe tu código JavaScript aquí..."></textarea>

     <div class="button-container">
        <button onclick="ejecutarCodigo()">Ejecutar Código</button>
        <button class="reset-button" onclick="resetEditor()">Reiniciar</button>
     </div>


    <!-- Área para entradas dinámicas -->
    <div id="dynamicInputArea" class="input-area">
        <label id="inputLabel" for="dynamicInput">Introduce un valor:</label>
        <input type="text" id="dynamicInput">
        <button onclick="enviarEntrada()">Enviar</button>
    </div>


    <h2>Resultado:</h2>
    <pre class="resultado" id="output"></pre>

    <!-- Iframe oculto para ejecutar el código de forma aislada -->
    <iframe id="sandbox"></iframe>

    <script>
        let currentCode = ''; // Almacena el código actual
        let executionPaused = false; // Indica si la ejecución está esperando una entrada
        let currentPromiseId = null; // Almacena el ID de la promesa pendiente en el iframe


        // Función para resetear el editor a su estado inicial
        function resetEditor() {
            document.getElementById('output').textContent = '';
            document.getElementById('javascriptCode').value = '';
            document.getElementById('dynamicInputArea').style.display = 'none';
            document.getElementById('dynamicInput').value = '';
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');
            ejecutarButton.textContent = 'Ejecutar Código';

            currentCode = '';
            executionPaused = false;
            currentPromiseId = null;

            // Reiniciar el iframe también
            const sandbox = document.getElementById('sandbox');
            // Remover el listener de mensajes anterior antes de recrear el iframe o su contenido
            window.removeEventListener('message', handleIframeMessage);

            sandbox.contentDocument.open();
            sandbox.contentDocument.write('');
            sandbox.contentDocument.close();

            console.log("Editor reiniciado.");
        }


        // Función principal para ejecutar/continuar el código
        async function ejecutarCodigo() {
            const outputElement = document.getElementById('output');
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');


            if (!executionPaused) {
                // Si no está pausado, es el inicio de la ejecución
                currentCode = document.getElementById('javascriptCode').value;
                outputElement.textContent = ''; // Limpiar resultado al inicio

                // Asegurarse de que solo haya un listener de mensajes activo
                window.removeEventListener('message', handleIframeMessage);
                window.addEventListener('message', handleIframeMessage);


                // Preparar el iframe para la ejecución inicial
                const sandbox = document.getElementById('sandbox');
                sandbox.contentDocument.open();
                sandbox.contentDocument.write('');
                sandbox.contentDocument.close();


                // Inyectar el código en el iframe con nuestra función de solicitud de entrada
                const scriptTag = `
                    <script>
                        // Mapa para almacenar funciones resolve de promesas pendientes
                        window._pendingPromises = {};
                        let promiseCounter = 0; // Contador simple para identificadores de promesas

                        // Redirigir console.log al padre
                        const originalConsoleLog = console.log;
                        console.log = function(...args) {
                            let message = args.map(arg => {
                                if (typeof arg === 'object') {
                                    try {
                                        return JSON.stringify(arg, null, 2);
                                    } catch (e) {
                                        return String(arg);
                                    }
                                }
                                return String(arg);
                            }).join(' ');
                            window.parent.postMessage({ type: 'log', message: message }, '*');
                            // originalConsoleLog.apply(console, args); // Opcional: también loguear en la consola del iframe
                        };

                        // Manejar errores no capturados
                        window.onerror = function(message, source, lineno, colno, error) {
                            window.parent.postMessage({ type: 'error', message: \`Error: \${message} at line \${lineno}\` }, '*');
                            return true; // Evita que el error se muestre en la consola del navegador principal
                        };

                        // ** Nuestra función simulada para solicitar entrada **
                        window.solicitarEntrada = async function(mensaje = 'Introduce un valor:') {
                            const promiseId = 'promise_' + promiseCounter++;
                            // Creamos una promesa y guardamos su función resolve en nuestro mapa
                            const promise = new Promise(resolve => {
                                window._pendingPromises[promiseId] = { resolve: resolve };
                            });

                            // Informamos al padre que necesitamos una entrada y le damos el ID de la promesa
                            window.parent.postMessage({ type: 'solicitar_entrada', mensaje: mensaje, promiseId: promiseId }, '*');

                            // Esperamos a que la promesa se resuelva (cuando el padre envíe la entrada)
                            return promise;
                        };

                        // ** Listener para recibir la entrada del padre **
                        window.addEventListener('message', function(event) {
                            const data = event.data;
                            if (data.type === 'entrada_recibida') {
                                const promiseId = data.promiseId;
                                const value = data.value;

                                // Encontrar la promesa correspondiente en nuestro mapa y resolverla
                                if (window._pendingPromises && window._pendingPromises[promiseId]) {
                                    const resolve = window._pendingPromises[promiseId].resolve;
                                    delete window._pendingPromises[promiseId]; // Limpiar del mapa
                                    resolve(value); // Resolver la promesa con el valor recibido
                                } else {
                                    console.error('Iframe: No se encontró la promesa con ID', promiseId);
                                }
                            }
                        });


                        // Ejecutar el código del usuario
                        (async () => { // Usamos una IIFE asíncrona para poder usar await con solicitarEntrada
                            try {
                                console.log("Ejecutando código...");
                                ${currentCode} // Aquí se ejecuta el código del usuario
                                console.log("Ejecución completa.");
                            } catch (e) {
                                window.parent.postMessage({ type: 'error', message: \`Error de ejecución: \${e.message}\` }, '*');
                            } finally {
                                window.parent.postMessage({ type: 'ejecucion_completa' }, '*');
                            }
                        })();


                    <\/script>
                `;

                 // Escribir el script en el iframe después de que esté listo
                sandbox.onload = () => {
                     sandbox.contentDocument.write(scriptTag);
                };
                 if (sandbox.contentDocument.readyState === 'complete') {
                     sandbox.onload(); // Si ya está listo, ejecutar onload manualmente
                 }


            } else {
                // Si está pausado, significa que tenemos una entrada para enviar
                // La lógica de envío ahora está en la función enviarEntrada
                enviarEntrada(); // Llama a enviarEntrada para procesar la entrada del campo
            }
        }

        // Manejador de mensajes del iframe
        function handleIframeMessage(event) {
            const data = event.data;
            const outputElement = document.getElementById('output');
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const inputLabel = document.getElementById('inputLabel');
            const dynamicInput = document.getElementById('dynamicInput');
             const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)'); // Obtener el botón de ejecutar/continuar

            // Asegurarse de que el mensaje provenga de nuestro iframe si tienes varios iframes o si la página puede recibir mensajes de otros orígenes
            // if (event.source !== document.getElementById('sandbox').contentWindow) {
            //     return;
            // }


            if (data.type === 'log') {
                outputElement.textContent += data.message + '\n';
            } else if (data.type === 'error') {
                 outputElement.textContent += data.message + '\n';
                 dynamicInputArea.style.display = 'none'; // Ocultar área de entrada en caso de error
                 ejecutarButton.textContent = 'Ejecutar Código'; // Restaurar texto del botón
                 executionPaused = false; // Resetear el estado
                 currentPromiseId = null; // Resetear
            } else if (data.type === 'solicitar_entrada') {
                // El iframe solicita una entrada
                executionPaused = true;
                currentPromiseId = data.promiseId; // Guardar el ID de la promesa
                inputLabel.textContent = data.mensaje; // Mostrar el mensaje de la solicitud
                dynamicInputArea.style.display = 'flex'; // Mostrar el área de entrada
                dynamicInput.value = ''; // Limpiar el campo de entrada
                dynamicInput.focus(); // Poner el foco en el campo de entrada
                 ejecutarButton.textContent = 'Continuar con Entrada'; // Cambiar texto del botón

            } else if (data.type === 'ejecucion_completa') {
                 // El código del iframe ha terminado
                 dynamicInputArea.style.display = 'none'; // Ocultar área de entrada si estaba visible
                 ejecutarButton.textContent = 'Ejecutar Código'; // Restaurar texto del botón
                 executionPaused = false; // Resetear el estado
                 currentPromiseId = null; // Resetear
            }
        }


        // Función para enviar la entrada del usuario al iframe
        function enviarEntrada() {
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const dynamicInput = document.getElementById('dynamicInput');
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');

            const inputValue = dynamicInput.value;

            if (executionPaused && currentPromiseId !== null) {
                 // Enviar un mensaje al iframe con el valor de entrada Y el ID de la promesa
                 const sandbox = document.getElementById('sandbox');
                 sandbox.contentWindow.postMessage({ type: 'entrada_recibida', value: inputValue, promiseId: currentPromiseId }, '*');

                 dynamicInputArea.style.display = 'none';
                 ejecutarButton.textContent = 'Ejecutar/Continuar Código';
                 currentPromiseId = null; // Ya no necesitamos el ID porque la promesa será resuelta en el iframe

            } else {
                console.error("No hay una solicitud de entrada pendiente.");
            }
        }

        // Permitir enviar entrada con la tecla Enter
        document.getElementById('dynamicInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && executionPaused) {
                event.preventDefault();
                enviarEntrada();
            }
        });

    </script>
</body>
</html>
