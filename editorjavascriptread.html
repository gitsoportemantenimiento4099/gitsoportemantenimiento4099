<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor JS con Entrada Paso a Paso</title>
    <style>
        /* ... (Estilos anteriores) ... */

        .instructions {
            width: 90%;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #d4edda; /* Un borde suave y color de fondo */
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.95em;
            color: #333;
        }

        .instructions p {
            margin-bottom: 10px;
        }

        .instructions code {
            background-color: #e9ecef;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }

        /* ... (El resto de tus estilos) ... */
    </style>
</head>
<body>

    <h1>Editor JS con Entrada Paso a Paso</h1>

    <div class="instructions">
        <p>Para solicitar una entrada al usuario dentro de tu código JavaScript, utiliza la función <code>await solicitarEntrada("Tu mensaje aquí:");</code>.</p>
        <p>La ejecución de tu código se pausará hasta que ingreses un valor en el campo de "Entrada para el código" que aparecerá y presiones "Enviar" o Enter.</p>
        <p>El valor ingresado estará disponible en la variable que le asignes (como en <code>let miVariable = await solicitarEntrada("...");</code>). Recuerda que el valor siempre se recibe como texto; usa <code>parseFloat()</code> o <code>parseInt()</code> si esperas números.</p>
    </div>


    <textarea id="javascriptCode" placeholder="Escribe tu código JavaScript aquí..."></textarea>

     <div class="button-container">
        <button onclick="ejecutarCodigo()">Ejecutar Código</button>
        <button class="reset-button" onclick="resetEditor()">Reiniciar</button>
     </div>


    <!-- Área para entradas dinámicas -->
    <div id="dynamicInputArea" class="input-area">
        <label id="inputLabel" for="dynamicInput">Introduce un valor:</label>
        <input type="text" id="dynamicInput">
        <button onclick="enviarEntrada()">Enviar</button>
    </div>


    <h2>Resultado:</h2>
    <pre class="resultado" id="output"></pre>

    <!-- Iframe oculto para ejecutar el código de forma aislada -->
    <iframe id="sandbox"></iframe>

    <script>
        // ... (Tu código JavaScript sin cambios) ...
        let currentCode = '';
        let executionPaused = false;
        let currentPromiseId = null;

        // ... (Funciones resetEditor, ejecutarCodigo, handleIframeMessage, enviarEntrada, listener de Enter) ...
        function resetEditor() {
            document.getElementById('output').textContent = '';
            document.getElementById('javascriptCode').value = '';
            document.getElementById('dynamicInputArea').style.display = 'none';
            document.getElementById('dynamicInput').value = '';
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');
            ejecutarButton.textContent = 'Ejecutar Código';

            currentCode = '';
            executionPaused = false;
            currentPromiseId = null;

            const sandbox = document.getElementById('sandbox');
            window.removeEventListener('message', handleIframeMessage);

            sandbox.contentDocument.open();
            sandbox.contentDocument.write('');
            sandbox.contentDocument.close();

            console.log("Editor reiniciado.");
        }

        async function ejecutarCodigo() {
            const outputElement = document.getElementById('output');
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');

            if (!executionPaused) {
                currentCode = document.getElementById('javascriptCode').value;
                outputElement.textContent = '';

                window.removeEventListener('message', handleIframeMessage);
                window.addEventListener('message', handleIframeMessage);

                const sandbox = document.getElementById('sandbox');
                sandbox.contentDocument.open();
                sandbox.contentDocument.write('');
                sandbox.contentDocument.close();

                const scriptTag = `
                    <script>
                        window._pendingPromises = {};
                        let promiseCounter = 0;

                        const originalConsoleLog = console.log;
                        console.log = function(...args) {
                            let message = args.map(arg => {
                                if (typeof arg === 'object') {
                                    try {
                                        return JSON.stringify(arg, null, 2);
                                    } catch (e) {
                                        return String(arg);
                                    }
                                }
                                return String(arg);
                            }).join(' ');
                            window.parent.postMessage({ type: 'log', message: message }, '*');
                        };

                        window.onerror = function(message, source, lineno, colno, error) {
                            window.parent.postMessage({ type: 'error', message: \`Error: \${message} at line \${lineno}\` }, '*');
                            return true;
                        };

                        window.solicitarEntrada = async function(mensaje = 'Introduce un valor:') {
                            const promiseId = 'promise_' + promiseCounter++;
                            const promise = new Promise(resolve => {
                                window._pendingPromises[promiseId] = { resolve: resolve };
                            });

                            window.parent.postMessage({ type: 'solicitar_entrada', mensaje: mensaje, promiseId: promiseId }, '*');

                            return promise;
                        };

                        window.addEventListener('message', function(event) {
                            const data = event.data;
                            if (data.type === 'entrada_recibida') {
                                const promiseId = data.promiseId;
                                const value = data.value;

                                if (window._pendingPromises && window._pendingPromises[promiseId]) {
                                    const resolve = window._pendingPromises[promiseId].resolve;
                                    delete window._pendingPromises[promiseId];
                                    resolve(value);
                                } else {
                                    console.error('Iframe: No se encontró la promesa con ID', promiseId);
                                }
                            }
                        });

                        (async () => {
                            try {
                                console.log("Ejecutando código...");
                                ${currentCode}
                                console.log("Ejecución completa.");
                            } catch (e) {
                                window.parent.postMessage({ type: 'error', message: \`Error de ejecución: \${e.message}\` }, '*');
                            } finally {
                                window.parent.postMessage({ type: 'ejecucion_completa' }, '*');
                            }
                        })();
                    <\/script>
                `;

                sandbox.onload = () => {
                     sandbox.contentDocument.write(scriptTag);
                };
                 if (sandbox.contentDocument.readyState === 'complete') {
                     sandbox.onload();
                 }


            } else {
                enviarEntrada();
            }
        }

        function handleIframeMessage(event) {
            const data = event.data;
            const outputElement = document.getElementById('output');
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const inputLabel = document.getElementById('inputLabel');
            const dynamicInput = document.getElementById('dynamicInput');
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');

            if (data.type === 'log') {
                outputElement.textContent += data.message + '\n';
            } else if (data.type === 'error') {
                 outputElement.textContent += data.message + '\n';
                 dynamicInputArea.style.display = 'none';
                 ejecutarButton.textContent = 'Ejecutar Código';
                 executionPaused = false;
                 currentPromiseId = null;
            } else if (data.type === 'solicitar_entrada') {
                executionPaused = true;
                currentPromiseId = data.promiseId;
                inputLabel.textContent = data.mensaje;
                dynamicInputArea.style.display = 'flex';
                dynamicInput.value = '';
                dynamicInput.focus();
                ejecutarButton.textContent = 'Continuar con Entrada';
            } else if (data.type === 'ejecucion_completa') {
                 dynamicInputArea.style.display = 'none';
                 ejecutarButton.textContent = 'Ejecutar Código';
                 executionPaused = false;
                 currentPromiseId = null;
            }
        }

        function enviarEntrada() {
            const dynamicInputArea = document.getElementById('dynamicInputArea');
            const dynamicInput = document.getElementById('dynamicInput');
            const ejecutarButton = document.querySelector('.button-container button:not(.reset-button)');

            const inputValue = dynamicInput.value;

            if (executionPaused && currentPromiseId !== null) {
                 const sandbox = document.getElementById('sandbox');
                 sandbox.contentWindow.postMessage({ type: 'entrada_recibida', value: inputValue, promiseId: currentPromiseId }, '*');

                 dynamicInputArea.style.display = 'none';
                 ejecutarButton.textContent = 'Ejecutar/Continuar Código';
                 currentPromiseId = null;

            } else {
                console.error("No hay una solicitud de entrada pendiente.");
            }
        }

        document.getElementById('dynamicInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && executionPaused) {
                event.preventDefault();
                enviarEntrada();
            }
        });

        // Listener para el botón de "Continuar con Entrada" (que es el mismo botón "Ejecutar")
        // Ya que el onclick del botón llama a ejecutarCodigo, y ejecutarCodigo maneja si está pausado,
        // no necesitamos un listener extra para el botón "Enviar". La función enviarEntrada
        // se llama desde ejecutarCodigo cuando executionPaused es true.


    </script>
</body>
</html>
